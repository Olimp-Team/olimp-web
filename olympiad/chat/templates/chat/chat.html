{% extends 'base_friends.html' %}
{% load static %}
{% block content %}
<h2>Чат с {{ other_user.username }}</h2>
<div id="chat-log-container" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
    <ul id="chat-log" style="list-style: none; padding: 0;">
        {% for message in messages %}
            <li id="message-{{ message.id }}" style="display: flex; align-items: center; margin-bottom: 10px;">
                {% if message.sender.image %}
                    <img src="{{ message.sender.image.url }}" alt="{{ message.sender.username }}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                {% else %}
                    <img src="{% static 'homepage/img/default-ava.png' %}" alt="{{ message.sender.username }}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                {% endif %}
                <div>
                    <strong>{{ message.sender.username }}:</strong>
                    <span class="message-content">{{ message.content }}</span>
                    <small>({{ message.timestamp }})</small>
                </div>
                {% if message.sender == request.user %}
                    <i class="fas fa-edit" onclick="enableEditMessage({{ message.id }})" style="font-size: small; cursor: pointer; margin-left: 10px;"></i>
                    <i class="fas fa-trash-alt" onclick="deleteMessage({{ message.id }}, '{% url 'chat:delete_message' message.id %}')" style="font-size: small; cursor: pointer; margin-left: 5px;"></i>
                    <i class="fas fa-save" id="save-button-{{ message.id }}" onclick="saveEditMessage({{ message.id }}, '{% url 'chat:update_message' message.id %}')" style="display:none; font-size: small; cursor: pointer; margin-left: 5px;"></i>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
</div>
<input id="chat-message-input" type="text" size="100" style="width: calc(100% - 110px);">
<button id="chat-message-submit" style="width: 100px;">Отправить</button>

<script>
    const roomName = "{{ other_user.username }}";
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');
        const messageElement = document.createElement('li');
        messageElement.id = `message-${data.id}`;
        messageElement.style.display = 'flex';
        messageElement.style.alignItems = 'center';
        messageElement.style.marginBottom = '10px';

        const avatarUrl = data.avatar ? data.avatar : '{% static "images/default-avatar.png" %}';
        const updateUrl = '{% url "chat:update_message" 0 %}'.replace('0', data.id);
        const deleteUrl = '{% url "chat:delete_message" 0 %}'.replace('0', data.id);

        messageElement.innerHTML = `
            <img src="${avatarUrl}" alt="${data.sender}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
            <div>
                <strong>${data.sender}:</strong> <span class="message-content">${data.message}</span> <small>(${new Date().toLocaleString()})</small>
            </div>
        `;

        if (data.sender === "{{ request.user.username }}") {
            messageElement.innerHTML += `
                <i class="fas fa-edit" onclick="enableEditMessage(${data.id})" style="font-size: small; cursor: pointer; margin-left: 10px;"></i>
                <i class="fas fa-trash-alt" onclick="deleteMessage(${data.id}, '${deleteUrl}')" style="font-size: small; cursor: pointer; margin-left: 5px;"></i>
                <i class="fas fa-save" id="save-button-${data.id}" onclick="saveEditMessage(${data.id}, '${updateUrl}')" style="display:none; font-size: small; cursor: pointer; margin-left: 5px;"></i>
            `;
        }

        chatLog.appendChild(messageElement);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-message-input').focus();
    document.getElementById('chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.getElementById('chat-message-submit').click();
        }
    };

    document.getElementById('chat-message-submit').onclick = function(e) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            const messageInputDom = document.getElementById('chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        } else {
            console.error('WebSocket is not open.');
        }
    };

    function deleteMessage(messageId, url) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                document.getElementById(`message-${messageId}`).remove();
            }
        });
    }

    function enableEditMessage(messageId) {
        const messageContentElement = document.querySelector(`#message-${messageId} .message-content`);
        const saveButton = document.getElementById(`save-button-${messageId}`);
        const editButton = document.querySelector(`#message-${messageId} .fa-edit`);
        
        messageContentElement.contentEditable = "true";
        messageContentElement.focus();
        saveButton.style.display = 'inline';
        editButton.style.display = 'none';
    }

    function saveEditMessage(messageId, url) {
        const messageContentElement = document.querySelector(`#message-${messageId} .message-content`);
        const newContent = messageContentElement.innerText;
        const saveButton = document.getElementById(`save-button-${messageId}`);
        const editButton = document.querySelector(`#message-${messageId} .fa-edit`);

        if (newContent) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `content=${encodeURIComponent(newContent)}`
            }).then(response => response.json())
              .then(data => {
                if (data.status === 'ok') {
                    messageContentElement.innerText = data.content;
                    messageContentElement.contentEditable = "false";
                    saveButton.style.display = 'none';
                    editButton.style.display = 'inline';
                }
            });
        }
    }
</script>
{% endblock %}
